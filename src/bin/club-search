#!/usr/bin/env node
const client  = require('../lib/client.js');
const chalk   = require('chalk');
const Spinner = require('cli-spinner').Spinner;
const spin    = new Spinner();
const log     = console.log;
var program   = require('commander');

program
    .version(require('../../package').version)
    .option('-a, --archived', 'Include archived Stories')
    .option('-l, --label [id|name]', 'Stories with label id/name', '')
    .option('-p, --project [id]', 'Stories in project', '')
    .option('-s, --state [id]', 'Stories in workflow state', '')
    .option('-t, --text [name]', 'Stories with text in name', '')
    .option('-y, --type [name]', 'Stories of type', '')
    .parse(process.argv);
spin.setSpinnerString(27);

const main = async () => {
    spin.start();
    const projects = await client.listProjects();

    const stories = await Promise.all(projects
        .filter(p => (p.id + '').match(program.project))
        .map(fetchStories));
    spin.stop(true);
    stories.map(printStories(projects));
    return;
};

const fetchStories = async (project) => {
    return client.listStories(project.id);
};

const printStories = (projects) => { return (stories, index) => {
    const project = projects[index];
    const filtered = stories.filter(s => {
        if (!(s.labels
            .map(l => `${l.id},${l.name}`).join(',') + '')
            .match(new RegExp(program.label, 'i'))) {
            return false;
        }
        if (!(s.workflow_state_id + '').match(program.state)) {
            return false;
        }
        if (!s.name.match(new RegExp(program.text, 'i'))) {
            return false;
        }
        if (!s.story_type.match(new RegExp(program.type, 'i'))) {
            return false;
        }
        if (!program.archived && s.archived) {
            return false;
        }
        return true;
    });
    if (!filtered.length) {
        return filtered;
    }
    return filtered.map(printStory(project));
};};

const printStory = (project) => { return (story) => {
    const labels = story.labels.map(l => {
        return chalk.bold(`#${l.id}`) + ` ${l.name}`;
    });
    log(chalk.bold(`#${story.id}`) + ` ${story.name}`);
    log(`  Type:    ${story.story_type}/${story.estimate || '_'}`);
    log(`  Label:   ${labels.join(', ')}`);
    log('  Project: ' + chalk.bold(`#${project.id}`) + ` ${project.name}`);
    if (story.archived) {
        log('  archived: ' + chalk.bold(story.archived));
    }
    return story;
};};

main();
